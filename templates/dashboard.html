<!DOCTYPE html>
<html>

<head>
    <title>{{ symbol }} Analysis - InvestSense</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .signal-card {
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .signal-buy {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .signal-sell {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .signal-hold {
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .strength-strong {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">InvestSense</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/portfolio">Portfolio</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="stocksDropdown" role="button"
                            data-bs-toggle="dropdown">
                            Stocks
                        </a>
                        <ul class="dropdown-menu" id="stocksList">
                            <li><a class="dropdown-item" href="/dashboard/AAPL">AAPL</a></li>
                            <li><a class="dropdown-item" href="/dashboard/MSFT">MSFT</a></li>
                            <li><a class="dropdown-item" href="/dashboard/GOOGL">GOOGL</a></li>
                            <li><a class="dropdown-item" href="/dashboard/AMZN">AMZN</a></li>
                        </ul>
                    </li>
                </ul>
                <form class="d-flex ms-auto" id="analyzeForm">
                    <input class="form-control me-2" type="search" id="symbolInput" placeholder="Enter Stock Symbol"
                        required>
                    <button class="btn btn-outline-light" type="submit">Analyze</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ symbol }} Sentiment Analysis</h1>
            <button class="btn btn-primary" id="refreshBtn">Refresh Data</button>
        </div>

        {% if error %}
        <div class="alert alert-danger mb-4" role="alert">
            {{ error }}
            <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-md-8">
                <!-- Sentiment Chart -->
                <div class="card mb-4">
                    <div class="card-header">
                        Sentiment Trend
                    </div>
                    <div class="card-body">
                        {% if sentiment_chart %}
                        <div id="sentimentChart"></div>
                        {% else %}
                        <p class="text-center">No sentiment data available</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Correlation Chart -->
                <div class="card mb-4">
                    <div class="card-header">
                        Sentiment vs. Stock Price
                    </div>
                    <div class="card-body">
                        {% if correlation_chart %}
                        <div id="correlationChart"></div>
                        {% else %}
                        <p class="text-center">No correlation data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Trading Signals -->
                <div class="card mb-4">
                    <div class="card-header">
                        Trading Signals
                    </div>
                    <div class="card-body">
                        {% if signals and not signals.error %}
                        {% for signal in signals %}
                        {% set signal_class = "signal-buy" if signal.type == "BUY" else "signal-sell" if signal.type ==
                        "SELL" else "signal-hold" %}
                        {% set strength_class = "strength-strong" if signal.strength == "STRONG" else "" %}
                        <div class="card signal-card {{ signal_class }} mb-3">
                            <div class="card-body">
                                <h5 class="card-title {{ strength_class }}">{{ signal.type }}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">Strength: {{ signal.strength }}</h6>
                                <p class="card-text">{{ signal.reason }}</p>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-center">No signals available</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Stock Info -->
                <div class="card">
                    <div class="card-header">
                        About {{ symbol }}
                    </div>
                    <div class="card-body">
                        <div id="stockInfo">
                            <p class="text-center">Loading stock information...</p>
                        </div>
                    </div>
                </div>

                <!-- Financial Metrics -->
                <div class="card mt-4">
                    <div class="card-header">
                        Financial Metrics
                    </div>
                    <div class="card-body">
                        <div id="financialMetrics">
                            <p class="text-center">Loading financial metrics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>InvestSense</h5>
                    <p>Advanced stock sentiment analysis platform</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2025 InvestSense. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Pass data from Flask to JavaScript -->
    <script>
        var SYMBOL = "{{ symbol }}";
        {% if sentiment_chart %}
        var SENTIMENT_CHART_DATA = {{ sentiment_chart | safe }};
        {% else %}
        var SENTIMENT_CHART_DATA = null;
        {% endif %}

        {% if correlation_chart %}
        var CORRELATION_CHART_DATA = {{ correlation_chart | safe }};
        {% else %}
        var CORRELATION_CHART_DATA = null;
        {% endif %}
    </script>

    <!-- Main JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize charts
            if (SENTIMENT_CHART_DATA) {
                Plotly.newPlot('sentimentChart', SENTIMENT_CHART_DATA.data, SENTIMENT_CHART_DATA.layout);
            }

            if (CORRELATION_CHART_DATA) {
                Plotly.newPlot('correlationChart', CORRELATION_CHART_DATA.data, CORRELATION_CHART_DATA.layout);
            }

            // Load stock information and financial metrics
            loadStockInfo();
            loadFinancialMetrics();

            // Set up event listeners
            document.getElementById('analyzeForm').addEventListener('submit', function (e) {
                e.preventDefault();
                var symbolInput = document.getElementById('symbolInput');
                var symbol = symbolInput.value.trim().toUpperCase();

                // Validate input
                if (!symbol) {
                    showInputError(symbolInput, 'Please enter a stock symbol');
                    return;
                }

                // Basic format validation (alphanumeric, not too long)
                if (!/^[A-Z0-9.]{1,10}$/.test(symbol)) {
                    showInputError(symbolInput, 'Invalid symbol format. Use 1-10 letters/numbers.');
                    return;
                }

                // Navigate to the dashboard
                window.location.href = '/dashboard/' + symbol;
            });

            // Helper function to show input errors
            function showInputError(inputElement, message) {
                // Remove any existing error messages
                var existingError = inputElement.parentElement.querySelector('.invalid-feedback');
                if (existingError) {
                    existingError.remove();
                }

                // Add error class to input
                inputElement.classList.add('is-invalid');

                // Create and append error message
                var errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = message;
                inputElement.parentElement.appendChild(errorDiv);

                // Focus the input
                inputElement.focus();

                // Remove error on input change
                inputElement.addEventListener('input', function () {
                    inputElement.classList.remove('is-invalid');
                    var feedback = inputElement.parentElement.querySelector('.invalid-feedback');
                    if (feedback) {
                        feedback.remove();
                    }
                }, { once: true });
            }

            document.getElementById('refreshBtn').addEventListener('click', function () {
                this.disabled = true;
                this.textContent = 'Refreshing...';

                // Remove any existing alerts
                const existingAlerts = document.querySelectorAll('.alert:not(.signal-card)');
                existingAlerts.forEach(alert => alert.remove());

                // Add loading indicator
                var loadingAlert = document.createElement('div');
                loadingAlert.className = 'alert alert-info';
                loadingAlert.id = 'loadingAlert';
                loadingAlert.innerHTML = '<strong>Loading...</strong> Fetching the latest data for ' + SYMBOL;
                document.querySelector('.container').insertBefore(loadingAlert, document.querySelector('.row'));

                // Set timeout to prevent infinite loading
                const timeout = setTimeout(() => {
                    if (document.getElementById('loadingAlert')) {
                        document.getElementById('loadingAlert').remove();

                        var timeoutAlert = document.createElement('div');
                        timeoutAlert.className = 'alert alert-danger';
                        timeoutAlert.innerHTML =
                            '<strong>Request timed out</strong> The server took too long to respond. Please try again later.' +
                            '<button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>';
                        document.querySelector('.container').insertBefore(timeoutAlert, document.querySelector('.row'));

                        this.disabled = false;
                        this.textContent = 'Refresh Data';
                    }
                }, 30000); // 30 second timeout

                // Make API request
                fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol: SYMBOL })
                })
                    .then(function (response) {
                        clearTimeout(timeout);
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.message || 'HTTP error! Status: ' + response.status);
                            });
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        if (data.status === 'error') {
                            throw new Error(data.message || 'Unknown error occurred');
                        }

                        // Show success message before reload
                        var successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success';
                        successAlert.innerHTML = '<strong>Success!</strong> Data refreshed successfully. Reloading page...';

                        // Remove loading indicator
                        var loadingAlert = document.getElementById('loadingAlert');
                        if (loadingAlert) {
                            loadingAlert.remove();
                        }

                        document.querySelector('.container').insertBefore(successAlert, document.querySelector('.row'));

                        // Reload the page after a brief delay
                        setTimeout(function () {
                            window.location.reload();
                        }, 1000);
                    })
                    .catch(function (error) {
                        clearTimeout(timeout);
                        console.error('Error:', error);

                        // Remove loading indicator
                        var loadingAlert = document.getElementById('loadingAlert');
                        if (loadingAlert) {
                            loadingAlert.remove();
                        }

                        // Show error message
                        var errorAlert = document.createElement('div');
                        errorAlert.className = 'alert alert-danger';
                        errorAlert.innerHTML =
                            '<strong>Error refreshing data:</strong> ' + (error.message || 'Unknown error') +
                            '<button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>';
                        document.querySelector('.container').insertBefore(errorAlert, document.querySelector('.row'));

                        // Reset button
                        this.disabled = false;
                        this.textContent = 'Refresh Data';
                    }.bind(this));
            });
        });

        function loadStockInfo() {
            fetch('https://query1.finance.yahoo.com/v8/finance/chart/' + SYMBOL)
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! Status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                        throw new Error('Invalid data format received from Yahoo Finance API');
                    }

                    var quote = data.chart.result[0].meta;
                    var stockInfoDiv = document.getElementById('stockInfo');

                    // Check if we have the required fields
                    if (!quote || !quote.regularMarketPrice || !quote.previousClose) {
                        throw new Error('Missing key data in Yahoo Finance response');
                    }

                    stockInfoDiv.innerHTML =
                        '<h5>' + quote.symbol + '</h5>' +
                        '<p><strong>Current Price:</strong> $' + quote.regularMarketPrice.toFixed(2) + '</p>' +
                        '<p><strong>Previous Close:</strong> $' + quote.previousClose.toFixed(2) + '</p>' +
                        '<p><strong>Market Cap:</strong> $' + (quote.marketCap ? (quote.marketCap / 1000000000).toFixed(2) + 'B' : 'N/A') + '</p>' +
                        '<p><strong>Range:</strong> $' + (quote.regularMarketDayLow ? quote.regularMarketDayLow.toFixed(2) : 'N/A') +
                        ' - $' + (quote.regularMarketDayHigh ? quote.regularMarketDayHigh.toFixed(2) : 'N/A') + '</p>';
                })
                .catch(function (error) {
                    console.error('Error fetching stock info:', error);
                    document.getElementById('stockInfo').innerHTML =
                        '<div class="alert alert-warning">' +
                        '<p><strong>Unable to load stock information</strong></p>' +
                        '<p>Error: ' + (error.message || 'Unknown error') + '</p>' +
                        '<p>Please try refreshing the data.</p>' +
                        '</div>';
                });
        }

        function loadFinancialMetrics() {
            fetch('/api/metrics/' + SYMBOL)
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! Status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function (metrics) {
                    var metricsDiv = document.getElementById('financialMetrics');

                    // Check if metrics contains error
                    if (metrics.error) {
                        throw new Error(metrics.error);
                    }

                    // Format numbers for display
                    var formatNumber = function (num, decimals) {
                        if (num === null || num === undefined || isNaN(num)) return 'N/A';
                        return Number(num).toFixed(decimals);
                    };

                    // Format large numbers with suffixes (K, M, B)
                    var formatLargeNumber = function (num) {
                        if (num === null || num === undefined || isNaN(num)) return 'N/A';
                        if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
                        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                        return num.toFixed(2);
                    };

                    // Build the table with fallbacks for missing data
                    metricsDiv.innerHTML =
                        '<table class="table table-sm">' +
                        '<tr><td><strong>P/E Ratio:</strong></td><td>' + formatNumber(metrics.pe_ratio, 2) + '</td></tr>' +
                        '<tr><td><strong>Market Cap:</strong></td><td>$' + formatLargeNumber(metrics.market_cap) + '</td></tr>' +
                        '<tr><td><strong>Dividend Yield:</strong></td><td>' + (metrics.dividend_yield ? formatNumber(metrics.dividend_yield, 2) + '%' : 'N/A') + '</td></tr>' +
                        '<tr><td><strong>52-Week High:</strong></td><td>$' + formatNumber(metrics["52wk_high"], 2) + '</td></tr>' +
                        '<tr><td><strong>52-Week Low:</strong></td><td>$' + formatNumber(metrics["52wk_low"], 2) + '</td></tr>' +
                        '<tr><td><strong>Avg. Volume:</strong></td><td>' + formatLargeNumber(metrics.avg_volume) + '</td></tr>' +
                        '<tr><td><strong>Beta:</strong></td><td>' + formatNumber(metrics.beta, 2) + '</td></tr>' +
                        '<tr><td><strong>EPS (TTM):</strong></td><td>$' + formatNumber(metrics.eps, 2) + '</td></tr>' +
                        '</table>';
                })
                .catch(function (error) {
                    console.error('Error fetching financial metrics:', error);
                    document.getElementById('financialMetrics').innerHTML =
                        '<div class="alert alert-warning">' +
                        '<p><strong>Unable to load financial metrics</strong></p>' +
                        '<p>Error: ' + (error.message || 'Unknown error') + '</p>' +
                        '<p>Please try refreshing the data.</p>' +
                        '</div>';
                });
        }
    </script>
</body>

</html>